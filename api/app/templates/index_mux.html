{% extends 'base.html' %}

{% block metadata %}
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="expires" content="0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="UTF-8">
    <meta property="og:title" content=deflax.net>
    <meta property="og:site_name" content="▷">
    <meta property="og:url" content=https://deflax.net>
    <meta property="og:description" content="The landing page of the flaxnet">
    <meta property="og:type" content=product>
    <meta property="og:image" content=https://deflax.net/static/images/logo.png>
    <meta name="viewport" content="width=device-width, initial-scale=1">
{% endblock %}

{% block title %}▷ Stream{% endblock %}

{% block content %}
<!-- Live Stream - Public Access -->
<div class="content-container bg-dark text-white">
  <div id="stream" class="container-fluid p-3 bg-dark text-white">
    <div class="row">
      <div class="col-md-1 d-none d-md-block">
      </div>
      <div class="col-12 col-lg-10">
          <div class="content">
              <video controls crossorigin playsinline muted poster="static/images/poster.png">
              </video>
              <div class="d-flex justify-content-between align-items-center mt-1 mb-2">
                <p class="mb-0 text-secondary" id="epg-now-playing" style="display:none;">
                  <i class="fa fa-play-circle" aria-hidden="true"></i> Now: <span id="epg-now-name"></span>
                </p>
                <p class="mb-0 text-secondary"><span id="visitor-number">-</span> <i class="fa fa-eye" aria-hidden="true"></i></p>
              </div>
              <div id="epg-schedule">
                <p class="text-secondary"><i class="fa fa-calendar" aria-hidden="true"></i> Loading schedule...</p>
              </div>
	        </div>
      </div>
      <div class="col-md-1 d-none d-md-block">
      </div>
    </div>
  </div>
</div>

<!-- Weather Modal Overlay -->
<div class="modal fade" id="weatherModal" tabindex="-1" aria-labelledby="weatherModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header border-secondary">
        <h5 class="modal-title" id="weatherModalLabel">Weather</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0">
        <iframe
          id="weatherIframe"
          src=""
          style="width: 100%; height: 100%; border: none;"
          allowfullscreen
          loading="lazy"
          referrerpolicy="no-referrer">
        </iframe>
      </div>
    </div>
  </div>
</div>

<!-- Archive Modal Overlay -->
<div class="modal fade" id="archiveModal" tabindex="-1" aria-labelledby="archiveModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header border-secondary">
        <h5 class="modal-title" id="archiveModalLabel">Archive</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="archiveModalBody">
        <div class="text-center p-5">
          <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

  // ---------------------------------------------------------------------------
  //  EPG - Electronic Program Guide rendering
  // ---------------------------------------------------------------------------

  let currentPlayheadId = null;
  let currentEpgDatabase = {};

  function renderEpg(database, playheadId) {
    const nowPlaying = document.getElementById('epg-now-playing');
    const nowName = document.getElementById('epg-now-name');
    const scheduleDiv = document.getElementById('epg-schedule');
    if (!scheduleDiv) return;

    const channelCount = Object.keys(database).length;

    // Update "Now Playing" from playhead
    if (nowPlaying && nowName) {
      if (playheadId && database[playheadId]) {
        nowName.textContent = database[playheadId].name;
        nowPlaying.style.display = 'block';
      } else {
        nowPlaying.style.display = 'none';
      }
    }

    // Hide schedule list when there is only a single channel
    if (channelCount <= 1) {
      scheduleDiv.innerHTML = '';
      return;
    }

    // Separate scheduled vs live entries
    const scheduled = [];
    const live = [];
    for (const [key, entry] of Object.entries(database)) {
      const startAt = entry.start_at;
      if (startAt !== 'now' && startAt !== 'never') {
        scheduled.push({id: key, name: entry.name, startAt: startAt, details: entry.details || ''});
      } else if (startAt === 'now') {
        live.push({id: key, name: entry.name, details: entry.details || ''});
      }
    }

    // Parse military time (e.g. '1745') or legacy hour (e.g. '14') and convert UTC to local
    for (const s of scheduled) {
      const raw = String(s.startAt).trim();
      let utcH, utcM;
      if (raw.length <= 2) {
        utcH = parseInt(raw); utcM = 0;
      } else {
        utcH = parseInt(raw.slice(0, -2)); utcM = parseInt(raw.slice(-2));
      }
      const utcDate = new Date();
      utcDate.setUTCHours(utcH, utcM, 0, 0);
      s.localHour = utcDate.getHours();
      s.localMinute = utcDate.getMinutes();
      s.localTotal = s.localHour * 60 + s.localMinute;
    }
    scheduled.sort((a, b) => a.localTotal - b.localTotal);

    let html = '';
    if (scheduled.length === 0 && live.length === 0) {
      html = '<p class="text-secondary">No scheduled streams.</p>';
    } else {
      if (scheduled.length > 0) {
        html += '<ul class="list-unstyled mb-1">';
        for (const s of scheduled) {
          const isActive = playheadId === s.id;
          const cls = isActive ? 'text-success' : 'text-secondary';
          const icon = isActive ? '<i class="fa fa-volume-up"></i> ' : '';
          const detail = s.details ? ` <small class="text-muted">- ${s.details}</small>` : '';
          const localStr = s.localHour.toString().padStart(2, '0') + ':' + s.localMinute.toString().padStart(2, '0');
          html += `<li class="${cls}">${icon}<strong>${localStr}</strong> ${s.name}${detail}</li>`;
        }
        html += '</ul>';
      }
      if (live.length > 0) {
        html += '<ul class="list-unstyled mb-0">';
        for (const l of live) {
          const detail = l.details ? ` <small class="text-muted">- ${l.details}</small>` : '';
          html += `<li class="text-warning"><i class="fa fa-broadcast-tower"></i> ${l.name} <span class="badge bg-danger">LIVE</span>${detail}</li>`;
        }
        html += '</ul>';
      }
    }
    scheduleDiv.innerHTML = html;
  }

  // ---------------------------------------------------------------------------
  //  SSE - Server-Sent Events for real-time updates
  // ---------------------------------------------------------------------------

  const video = document.querySelector("video");
  const visitorNumber = document.getElementById('visitor-number');

  function connectSSE() {
    const evtSource = new EventSource('/events');

    evtSource.addEventListener('playhead', function(e) {
      const data = JSON.parse(e.data);
      currentPlayheadId = data.id || null;

      // Re-render EPG to update active highlight
      if (Object.keys(currentEpgDatabase).length > 0) {
        renderEpg(currentEpgDatabase, currentPlayheadId);
      }
      // Note: Video source is static (/live/stream.m3u8), mux service handles switching
    });

    evtSource.addEventListener('visitors', function(e) {
      const data = JSON.parse(e.data);
      if (visitorNumber) {
        visitorNumber.textContent = data.visitors;
      }
    });

    evtSource.addEventListener('epg', function(e) {
      try {
        currentEpgDatabase = JSON.parse(e.data);
        renderEpg(currentEpgDatabase, currentPlayheadId);
      } catch (err) {
        console.warn('EPG: failed to parse data', err);
      }
    });

    evtSource.onerror = function() {
      console.warn("SSE: connection lost, reconnecting...");
      // EventSource auto-reconnects, but close explicitly if CLOSED
      if (evtSource.readyState === EventSource.CLOSED) {
        evtSource.close();
        setTimeout(connectSSE, 3000);
      }
    };
  }

  // ---------------------------------------------------------------------------
  //  HLS - Video player setup (Plyr + HLS.js)
  // ---------------------------------------------------------------------------

  const hlsSource = '/live/stream.m3u8';
  const defaultOptions = {};

  function updateQuality(newQuality) {
    if (newQuality === 0) {
      window.hls.currentLevel = -1; //Enable AUTO quality if option.value = 0
    } else {
      window.hls.levels.forEach((level, levelIndex) => {
        if (level.height === newQuality) {
          console.log("HLS.js: Found quality match with " + newQuality);
          window.hls.currentLevel = levelIndex;
        }
      });
    }
  }

  function initPlayer() {
    // For more options, see: https://github.com/sampotts/plyr/#options
    if (video.canPlayType('application/vnd.apple.mpegurl')) {
      // Native HLS (Safari)
      video.src = hlsSource;
      const player = new Plyr(video, defaultOptions);
    } else if (Hls.isSupported()) {
      const hls = new Hls();

      hls.loadSource(hlsSource);
      hls.attachMedia(video);

      // From the m3u8 playlist, hls parses the manifest and returns
      // all available video qualities.
      hls.on(Hls.Events.MANIFEST_PARSED, function (event, data) {
        console.log("HLS.js: manifest parsed");

        // Transform available levels into an array of integers (height values).
        const availableQualities = hls.levels.map((l) => l.height);
        availableQualities.unshift(0); //prepend 0 to quality array

        defaultOptions.quality = {
          default: 0, //Default - AUTO
          options: availableQualities,
          forced: true,
          onChange: (e) => updateQuality(e),
        };

        defaultOptions.i18n = {
          qualityLabel: {
            0: 'Auto',
          },
        };

        hls.on(Hls.Events.LEVEL_SWITCHED, function (event, data) {
          console.log("HLS.js: level switched");
          var span = document.querySelector(".plyr__menu__container [data-plyr='quality'][value='0'] span");
          if (hls.autoLevelEnabled) {
            span.innerHTML = `AUTO (${hls.levels[data.level].height}p)`;
          } else {
            span.innerHTML = `AUTO`;
          }
        });

        const player = new Plyr(video, defaultOptions);
      });

      window.hls = hls;
    }
  }

  // ---------------------------------------------------------------------------
  //  Modal overlays - Weather & Archive (keep video playing underneath)
  // ---------------------------------------------------------------------------

  const WEATHER_SRC = 'https://earth.nullschool.net/#current/wind/surface/level/overlay=temp/orthographic=16.78,46.84,2310/loc=24.738,42.213';

  // -- Weather modal --

  function initWeatherModal() {
    const link = document.querySelector('a.nav-link[href="/weather"]');
    if (!link) return;

    link.addEventListener('click', (e) => {
      e.preventDefault();
      const iframe = document.getElementById('weatherIframe');
      if (!iframe.src || iframe.src === '' || iframe.src === window.location.href) {
        iframe.src = WEATHER_SRC;
      }
      const modal = new bootstrap.Modal(document.getElementById('weatherModal'));
      modal.show();
    });

    // Cleanup iframe when modal is closed to save resources
    document.getElementById('weatherModal').addEventListener('hidden.bs.modal', () => {
      document.getElementById('weatherIframe').src = '';
    });
  }

  // -- Archive modal --

  function loadArchiveContent(modalBody) {
    fetch('/archive', { credentials: 'same-origin' })
      .then(r => r.text())
      .then(html => {
        const doc = new DOMParser().parseFromString(html, 'text/html');
        const content = doc.querySelector('.content-container');
        if (content) {
          modalBody.innerHTML = content.innerHTML;
          modalBody.querySelectorAll('script').forEach(s => s.remove());
          bindArchiveInteractions(modalBody);
        } else {
          modalBody.innerHTML = '<div class="alert alert-danger m-3">Failed to load archive content.</div>';
        }
      })
      .catch(() => {
        modalBody.innerHTML = '<div class="alert alert-danger m-3">Failed to load archive content.</div>';
      });
  }

  function bindArchiveInteractions(modalBody) {
    const form = modalBody.querySelector('#timecodeForm');
    const requestBtn = modalBody.querySelector('#requestTimecodeBtn');
    const statusDiv = modalBody.querySelector('#timecodeRequestStatus');

    // Timecode submission form
    if (form) {
      form.addEventListener('submit', async (evt) => {
        evt.preventDefault();
        const formData = new FormData(form);
        const response = await fetch('/archive', {
          method: 'POST',
          body: formData,
          credentials: 'same-origin'
        });
        const responseHtml = await response.text();
        const respDoc = new DOMParser().parseFromString(responseHtml, 'text/html');
        const respContent = respDoc.querySelector('.content-container');
        if (respContent) {
          modalBody.innerHTML = respContent.innerHTML;
          modalBody.querySelectorAll('script').forEach(s => s.remove());
          bindArchiveInteractions(modalBody);
        }
      });
    }

    // Request timecode button with cooldown
    if (requestBtn && statusDiv) {
      let cooldownRemaining = 0;
      let cooldownInterval = null;

      function updateCooldownText() {
        requestBtn.textContent = `Wait ${cooldownRemaining}s`;
      }

      function startCooldown() {
        cooldownRemaining = 60;
        requestBtn.disabled = true;
        updateCooldownText();
        cooldownInterval = setInterval(() => {
          cooldownRemaining--;
          if (cooldownRemaining <= 0) {
            clearInterval(cooldownInterval);
            cooldownInterval = null;
            requestBtn.disabled = false;
            requestBtn.textContent = 'Request Timecode';
          } else {
            updateCooldownText();
          }
        }, 1000);
      }

      requestBtn.addEventListener('click', async () => {
        if (cooldownRemaining > 0) return;
        requestBtn.disabled = true;
        requestBtn.textContent = 'Requesting...';
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = '<div class="alert alert-info">Requesting timecode...</div>';

        try {
          const response = await fetch('/request-timecode', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
          const data = await response.json();
          if (data.success) {
            statusDiv.innerHTML = `<div class="alert alert-success">
              <strong>Success!</strong> Timecode has been sent to Discord channel.<br>
              <small>Hostname: ${data.obfuscated_hostname}</small>
            </div>`;
            startCooldown();
          } else {
            statusDiv.innerHTML = '<div class="alert alert-danger">Failed to request timecode. Please try again.</div>';
            requestBtn.disabled = false;
            requestBtn.textContent = 'Request Timecode';
          }
        } catch (error) {
          statusDiv.innerHTML = '<div class="alert alert-danger">Error requesting timecode. Please try again.</div>';
          requestBtn.disabled = false;
          requestBtn.textContent = 'Request Timecode';
        }
      });
    }
  }

  function initArchiveModal() {
    const link = document.querySelector('a.nav-link[href="/archive"]');
    if (!link) return;

    link.addEventListener('click', (e) => {
      e.preventDefault();
      const modalBody = document.getElementById('archiveModalBody');
      modalBody.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-light" role="status"><span class="visually-hidden">Loading...</span></div></div>';
      const modal = new bootstrap.Modal(document.getElementById('archiveModal'));
      modal.show();
      loadArchiveContent(modalBody);
    });
  }

  // ---------------------------------------------------------------------------
  //  Initialize everything
  // ---------------------------------------------------------------------------

  initPlayer();
  connectSSE();
  initWeatherModal();
  initArchiveModal();

});
</script>
{% endblock %}
