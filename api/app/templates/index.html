{% extends 'base.html' %}

{% block metadata %}
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="expires" content="0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="UTF-8">
    <meta property="og:title" content=deflax.net>
    <meta property="og:site_name" content="▷">
    <meta property="og:url" content=https://deflax.net>
    <meta property="og:description" content="The landing page of the flaxnet">
    <meta property="og:type" content=product>
    <meta property="og:image" content=https://deflax.net/static/images/logo.png>
    <meta name="viewport" content="width=device-width, initial-scale=1">
{% endblock %}

{% block title %}▷ deflax.net{% endblock %}

{% block content %}
<!-- Live Stream - Public Access -->
<div class="content-container bg-dark text-white">
  <div id="stream" class="container-fluid p-3 bg-dark text-white">
    <div class="row">
      <div class="col-md-1 d-none d-md-block">
      </div>
      <div class="col-12 col-lg-10">
          <div class="content">
              <video controls crossorigin playsinline muted poster="static/images/poster.png">
              </video>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const video = document.querySelector("video");
  const source = 'https://stream.deflax.net/memfs/f2844c7c-e86c-4f0a-afb6-a1b0e25a5071.m3u8';
  const visitorNumber = document.getElementById('visitor-number');
  let currentPlayheadId = null;
  let currentEpgDatabase = {};

  // For more options, see: https://github.com/sampotts/plyr/#options
  const defaultOptions = {};

  //
  // EPG rendering
  //
  function renderEpg(database, playheadId) {
    const nowPlaying = document.getElementById('epg-now-playing');
    const nowName = document.getElementById('epg-now-name');
    const scheduleDiv = document.getElementById('epg-schedule');
    if (!scheduleDiv) return;

    // Update "Now Playing" from playhead
    if (nowPlaying && nowName) {
      if (playheadId && database[playheadId]) {
        nowName.textContent = database[playheadId].name;
        nowPlaying.style.display = 'block';
      } else {
        nowPlaying.style.display = 'none';
      }
    }

    // Separate scheduled vs live entries
    const scheduled = [];
    const live = [];
    for (const [key, entry] of Object.entries(database)) {
      const startAt = entry.start_at;
      if (startAt !== 'now' && startAt !== 'never') {
        scheduled.push({id: key, name: entry.name, hour: startAt, details: entry.details || ''});
      } else if (startAt === 'now') {
        live.push({id: key, name: entry.name, details: entry.details || ''});
      }
    }

    // Sort scheduled by hour
    scheduled.sort((a, b) => parseInt(a.hour) - parseInt(b.hour));

    let html = '';
    if (scheduled.length === 0 && live.length === 0) {
      html = '<p class="text-secondary">No scheduled streams.</p>';
    } else {
      if (scheduled.length > 0) {
        html += '<ul class="list-unstyled mb-1">';
        for (const s of scheduled) {
          const isActive = playheadId === s.id;
          const cls = isActive ? 'text-success' : 'text-secondary';
          const icon = isActive ? '<i class="fa fa-volume-up"></i> ' : '';
          const detail = s.details ? ` <small class="text-muted">- ${s.details}</small>` : '';
          html += `<li class="${cls}">${icon}<strong>${s.hour}:00</strong> ${s.name}${detail}</li>`;
        }
        html += '</ul>';
      }
      if (live.length > 0) {
        html += '<ul class="list-unstyled mb-0">';
        for (const l of live) {
          const detail = l.details ? ` <small class="text-muted">- ${l.details}</small>` : '';
          html += `<li class="text-warning"><i class="fa fa-broadcast-tower"></i> ${l.name} <span class="badge bg-danger">LIVE</span>${detail}</li>`;
        }
        html += '</ul>';
      }
    }
    scheduleDiv.innerHTML = html;
  }

  //
  // SSE connection for real-time playhead, visitor, and EPG updates
  //
  function connectSSE() {
    const evtSource = new EventSource('/events');

    evtSource.addEventListener('playhead', function(e) {
      const data = JSON.parse(e.data);
      currentPlayheadId = data.id || null;

      // Re-render EPG to update active highlight
      if (Object.keys(currentEpgDatabase).length > 0) {
        renderEpg(currentEpgDatabase, currentPlayheadId);
      }

      if (!data.head) return;

      if (video.canPlayType('application/vnd.apple.mpegurl')) {
        // Native HLS (Safari)
        if (video.src !== data.head) {
          video.src = data.head;
          console.log("Video: switching to ", data.head);
        }
      } else if (window.hls) {
        // HLS.js
        const oldsrc = window.hls.url;
        const newsrc = data.head;
        if (newsrc !== oldsrc) {
          console.log("HLS.js: switching to ", newsrc);
          window.hls.loadSource(newsrc);
          video.load();
          video.play().catch(error => {
            console.error('HLS.js: Autoplay was prevented:', error);
          });
        }
      }
    });

    evtSource.addEventListener('visitors', function(e) {
      const data = JSON.parse(e.data);
      if (visitorNumber) {
        visitorNumber.textContent = data.visitors;
      }
    });

    evtSource.addEventListener('epg', function(e) {
      try {
        currentEpgDatabase = JSON.parse(e.data);
        renderEpg(currentEpgDatabase, currentPlayheadId);
      } catch (err) {
        console.warn('EPG: failed to parse data', err);
      }
    });

    evtSource.onerror = function() {
      console.warn("SSE: connection lost, reconnecting...");
      // EventSource auto-reconnects, but close explicitly if CLOSED
      if (evtSource.readyState === EventSource.CLOSED) {
        evtSource.close();
        setTimeout(connectSSE, 3000);
      }
    };
  }

  //
  // First check for native browser HLS support
  //
  if (video.canPlayType('application/vnd.apple.mpegurl')) {
    const player = new Plyr(video, defaultOptions);
    // SSE will handle setting video.src when playhead event arrives
    //
    // If no native HLS support, check if HLS.js is supported
    //
  } else if (Hls.isSupported()) {
    const hls = new Hls();

    // Attach Hls.js to the video element
    hls.loadSource(source);
    hls.attachMedia(video);

    // From the m3u8 playlist, hls parses the manifest and returns
    // all available video qualities. This is important; in this approach,
    // we will have one source on the Plyr player.
    hls.on(Hls.Events.MANIFEST_PARSED, function (event, data) {
      console.log("HLS.js: manifest parsed");

      // Transform available levels into an array of integers (height values).
      const availableQualities = hls.levels.map((l) => l.height)
      availableQualities.unshift(0); //prepend 0 to quality array

      // Add new qualities to option
      defaultOptions.quality = {
        default: 0, //Default - AUTO
        options: availableQualities,
        forced: true,
        onChange: (e) => updateQuality(e),
      }

      // Add Auto Label 
      defaultOptions.i18n = {
        qualityLabel: {
          0: 'Auto',
        },
      }

      hls.on(Hls.Events.LEVEL_SWITCHED, function (event, data) {
        console.log("HLS.js: level switched");
        var span = document.querySelector(".plyr__menu__container [data-plyr='quality'][value='0'] span")
        if (hls.autoLevelEnabled) {
          span.innerHTML = `AUTO (${hls.levels[data.level].height}p)`
        } else {
          span.innerHTML = `AUTO`
        }
      });

      // Initialize new Plyr player with quality options
      const player = new Plyr(video, defaultOptions);
    });

    window.hls = hls;
  }

  function updateQuality(newQuality) {
    if (newQuality === 0) {
      window.hls.currentLevel = -1; //Enable AUTO quality if option.value = 0
    } else {
      window.hls.levels.forEach((level, levelIndex) => {
        if (level.height === newQuality) {
          console.log("HLS.js: Found quality match with " + newQuality);
          window.hls.currentLevel = levelIndex;
        }
      });
    }
  }

  // Start the SSE connection
  connectSSE();
});

</script>
              <p class="mt-1 mb-1 text-secondary text-end"><span id="visitor-number">-</span> <i class="fa fa-eye" aria-hidden="true"></i></p>
              <div id="epg-now-playing" class="mb-2" style="display:none;">
                <span class="text-success"><i class="fa fa-play-circle" aria-hidden="true"></i> Now:</span>
                <span id="epg-now-name" class="text-light"></span>
              </div>
              <div id="epg-schedule">
                <p class="text-secondary"><i class="fa fa-calendar" aria-hidden="true"></i> Loading schedule...</p>
              </div>
	        </div>
      </div>
      <div class="col-md-1 d-none d-md-block">
      </div>
    </div>
  </div>
</div>
{% endblock %}
