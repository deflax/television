<!DOCTYPE html>
<html>
<head>
    {% block metadata %}{% endblock %}

    <title>{% block title %}{% endblock %}</title>

    <link rel='shortcut icon' type='image/x-icon' href='/static/images/favicon.ico' />
    <link rel="stylesheet" href="/static/css/root.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap/dist/css/bootstrap.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/plyr/dist/plyr.min.css">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap/dist/js/bootstrap.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/plyr/dist/plyr.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js/dist/hls.min.js" crossorigin="anonymous"></script>

    <style>
        body {
	        background-color: #212529;
        }
    </style>
</head>

<body>
{% include 'nav.html' %}

{% block content %}{% endblock %}

{% include 'footer.html' %}

<!-- Weather Modal (global) -->
<div class="modal fade" id="weatherModal" tabindex="-1" aria-labelledby="weatherModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header border-secondary">
        <h5 class="modal-title" id="weatherModalLabel">Weather</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0">
        <iframe
          id="weatherIframe"
          src=""
          style="width: 100%; height: 100%; border: none;"
          allowfullscreen
          loading="lazy"
          referrerpolicy="no-referrer">
        </iframe>
      </div>
    </div>
  </div>
</div>

<!-- Archive Modal (global) -->
<div class="modal fade" id="archiveModal" tabindex="-1" aria-labelledby="archiveModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header border-secondary">
        <h5 class="modal-title" id="archiveModalLabel">Archive</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="archiveModalBody">
        <div class="text-center p-5">
          <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Global modal initialization
document.addEventListener('DOMContentLoaded', () => {
  const WEATHER_SRC = 'https://earth.nullschool.net/#current/wind/surface/level/overlay=temp/orthographic=16.78,46.84,2310/loc=24.738,42.213';
  
  // Weather modal
  const weatherLink = document.querySelector('a.nav-link[href="/weather"]');
  if (weatherLink) {
    weatherLink.addEventListener('click', (e) => {
      e.preventDefault();
      const iframe = document.getElementById('weatherIframe');
      if (!iframe.src || iframe.src === '' || iframe.src === window.location.href) {
        iframe.src = WEATHER_SRC;
      }
      const modal = new bootstrap.Modal(document.getElementById('weatherModal'));
      modal.show();
    });
  }

  // Cleanup iframe when modal is closed
  const weatherModal = document.getElementById('weatherModal');
  if (weatherModal) {
    weatherModal.addEventListener('hidden.bs.modal', () => {
      document.getElementById('weatherIframe').src = '';
    });
  }

  // Archive modal
  function loadArchiveContent(modalBody) {
    fetch('/archive', { credentials: 'same-origin' })
      .then(r => r.text())
      .then(html => {
        const doc = new DOMParser().parseFromString(html, 'text/html');
        const content = doc.querySelector('.content-container');
        if (content) {
          modalBody.innerHTML = content.innerHTML;
          modalBody.querySelectorAll('script').forEach(s => s.remove());
          bindArchiveInteractions(modalBody);
        } else {
          modalBody.innerHTML = '<div class="alert alert-danger m-3">Failed to load archive content.</div>';
        }
      })
      .catch(() => {
        modalBody.innerHTML = '<div class="alert alert-danger m-3">Failed to load archive content.</div>';
      });
  }

  function bindArchiveInteractions(modalBody) {
    const form = modalBody.querySelector('#timecodeForm');
    const requestBtn = modalBody.querySelector('#requestTimecodeBtn');
    const statusDiv = modalBody.querySelector('#timecodeRequestStatus');

    // Timecode submission form
    if (form) {
      form.addEventListener('submit', async (evt) => {
        evt.preventDefault();
        const formData = new FormData(form);
        const response = await fetch('/archive', {
          method: 'POST',
          body: formData,
          credentials: 'same-origin'
        });
        const responseHtml = await response.text();
        const respDoc = new DOMParser().parseFromString(responseHtml, 'text/html');
        const respContent = respDoc.querySelector('.content-container');
        if (respContent) {
          modalBody.innerHTML = respContent.innerHTML;
          modalBody.querySelectorAll('script').forEach(s => s.remove());
          bindArchiveInteractions(modalBody);
        }
      });
    }

    // Request timecode button with cooldown
    if (requestBtn && statusDiv) {
      let cooldownRemaining = 0;
      let cooldownInterval = null;

      function updateCooldownText() {
        requestBtn.textContent = `Wait ${cooldownRemaining}s`;
      }

      function startCooldown() {
        cooldownRemaining = 60;
        requestBtn.disabled = true;
        updateCooldownText();
        cooldownInterval = setInterval(() => {
          cooldownRemaining--;
          if (cooldownRemaining <= 0) {
            clearInterval(cooldownInterval);
            cooldownInterval = null;
            requestBtn.disabled = false;
            requestBtn.textContent = 'Request Timecode';
          } else {
            updateCooldownText();
          }
        }, 1000);
      }

      requestBtn.addEventListener('click', async () => {
        if (cooldownRemaining > 0) return;
        requestBtn.disabled = true;
        requestBtn.textContent = 'Requesting...';
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = '<div class="alert alert-info">Requesting timecode...</div>';

        try {
          const response = await fetch('/request-timecode', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
          const data = await response.json();
          if (data.success) {
            statusDiv.innerHTML = `<div class="alert alert-success">
              <strong>Success!</strong> Timecode has been sent to Discord channel.<br>
              <small>Hostname: ${data.obfuscated_hostname}</small>
            </div>`;
            startCooldown();
          } else {
            statusDiv.innerHTML = '<div class="alert alert-danger">Failed to request timecode. Please try again.</div>';
            requestBtn.disabled = false;
            requestBtn.textContent = 'Request Timecode';
          }
        } catch (error) {
          statusDiv.innerHTML = '<div class="alert alert-danger">Error requesting timecode. Please try again.</div>';
          requestBtn.disabled = false;
          requestBtn.textContent = 'Request Timecode';
        }
      });
    }
  }

  const archiveLink = document.querySelector('a.nav-link[href="/archive"]');
  if (archiveLink) {
    archiveLink.addEventListener('click', (e) => {
      e.preventDefault();
      const modalBody = document.getElementById('archiveModalBody');
      modalBody.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-light" role="status"><span class="visually-hidden">Loading...</span></div></div>';
      const modal = new bootstrap.Modal(document.getElementById('archiveModal'));
      modal.show();
      loadArchiveContent(modalBody);
    });
  }
});
</script>

</body>
</html>
